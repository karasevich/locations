<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ì–µ–æ–ø–æ–∑–∏—Ü—ñ—ó –∑ –∫–∞—Ä—Ç–∏</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    #map { height: 70vh; width: 100%; margin-top: 20px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>–î–æ–¥–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –≥–µ–æ–ø–æ–∑–∏—Ü—ñ—é</h2>
  <button onclick="sendLocation()">üìç –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
  <p id="status"></p>
  <div id="map"></div>

  <!-- API Key –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ Apps Script -->
  <script src="https://maps.googleapis.com/maps/api/js?key=<?= apiKey ?>"></script>

  <script>
    const scriptURL = "<?= ScriptApp.getService().getUrl() ?>"; // Apps Script /exec
    const sheetURL = "<?= ScriptApp.getService().getUrl() ?>?action=getPoints";
    let map;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 2
      });
      loadPoints();
      setInterval(loadPoints, 30000);
    }

    function sendLocation() {
      const status = document.getElementById("status");
      status.textContent = "–û—Ç—Ä–∏–º—É—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏...";
      if (!navigator.geolocation) {
        status.textContent = "–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è.";
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const data = {
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude,
          note: "–ó —Ç–µ–ª–µ—Ñ–æ–Ω—É"
        };
        fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
        .then(() => { status.textContent = "‚úÖ –ü–æ–∑–∏—Ü—ñ—é –¥–æ–¥–∞–Ω–æ!"; loadPoints(); })
        .catch(err => { status.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + err; });
      }, err => {
        status.textContent = "–ü–æ–º–∏–ª–∫–∞: " + err.message;
      });
    }

    function loadPoints() {
      fetch(sheetURL)
        .then(r => r.json())
        .then(points => {
          if (window.markers) window.markers.forEach(m => m.setMap(null));
          window.markers = [];
          points.forEach(p => {
            const marker = new google.maps.Marker({
              position: { lat: Number(p.lat), lng: Number(p.lon) },
              map: map,
              title: p.note
            });
            window.markers.push(marker);
          });
          if (points.length > 0) {
            map.setCenter({ lat: Number(points[0].lat), lng: Number(points[0].lon) });
            map.setZoom(8);
          }
        })
        .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–µ–∫:", err));
    }

    window.onload = initMap;
  </script>
</body>
</html>
